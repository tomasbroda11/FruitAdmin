{% extends 'base.html' %}

{% block title %}Nuevo Pedido{% endblock %}

{% block content %}
<h2>Nuevo Pedido</h2>
<form method="post">
    {% csrf_token %}
    {{ pedido_form.as_p }}

    <h3>Productos</h3>
    <div id="producto-formset">
        {{ producto_formset.management_form }}
        {% for form in producto_formset.forms %}
            <div class="form-group">
                {{ form.producto.label_tag }} {{ form.producto }}
                {{ form.cantidad.label_tag }} {{ form.cantidad }}
                <button type="button" class="btn btn-danger" onclick="removeForm(this)">Eliminar</button>
            </div>
        {% endfor %}
    </div>
    <button type="button" class="btn btn-secondary" id="agregar-producto">Agregar Producto</button>
    <div class="form-group">
        <label>Precio Total</label>
        <input type="text" id="precio-total" value="0" readonly class="form-control">
    </div>
    <button type="submit" class="btn btn-primary">Crear Pedido</button>
    </form>

<script>
    /*
    document.addEventListener('DOMContentLoaded', function() {
        const formsetContainer = document.getElementById('producto-formset');
        const addButton = document.getElementById('agregar-producto');
        const totalPriceInput = document.getElementById('precio-total');
        let formCount = {{ producto_formset.total_form_count }};

        addButton.addEventListener('click', function() {
            const newForm = formsetContainer.querySelector('.form-group').cloneNode(true);
            
            // Actualizar los índices del nuevo formulario
            newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, formCount);
            
            // Limpiar los valores del nuevo formulario
            newForm.querySelectorAll('select, input').forEach(input => {
                input.value = '';
            });

            // Agregar el botón de eliminar HAY QUE BORRARLO/COMENTARLO
            const deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.className = 'btn btn-danger';
            deleteButton.textContent = 'Eliminar';
            deleteButton.onclick = function() { removeForm(this); };
            newForm.appendChild(deleteButton);

            formsetContainer.appendChild(newForm);

            // Actualizar el número total de formularios
            const totalForms = document.getElementById('id_producto_set-TOTAL_FORMS');
            totalForms.value = ++formCount;
        });

        // Función para eliminar un formulario
        window.removeForm = function(button) {
            const formGroup = button.closest('.form-group');
            formGroup.remove();
            
            // Actualizar el número total de formularios
            const totalForms = document.getElementById('id_producto_set-TOTAL_FORMS');
            totalForms.value = --formCount;

            updateTotalPrice();
        };

        // Función para actualizar el precio total
        function updateTotalPrice() {
            let total = 0;
            formsetContainer.querySelectorAll('.form-group').forEach(formGroup => {
                const cantidad = formGroup.querySelector('input[name$="-cantidad"]').value;
                const productoSelect = formGroup.querySelector('select[name$="-producto"]');
                const precio = productoSelect.options[productoSelect.selectedIndex].dataset.precio;
                total += cantidad * precio;
            });
            totalPriceInput.value = total.toFixed(2);
        }

        // Agregar event listeners para actualizar el precio total
        formsetContainer.addEventListener('change', updateTotalPrice);
        addButton.addEventListener('click', updateTotalPrice);
    }); */
</script>

{% endblock %}